<!DOCTYPE html>
<html lang="en">
<head>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDD8u8CBRjWRI-khUfJxmyINSeTMeqaF24",
      authDomain: "jeu-des-24.firebaseapp.com",
      projectId: "jeu-des-24",
      storageBucket: "jeu-des-24.firebasestorage.app",
      messagingSenderId: "948758114165",
      appId: "1:948758114165:web:edcb63e71fb41eca6eed3c",
      measurementId: "G-RNL88LYHW5"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app, "https://jeu-des-24-default-rtdb.europe-west1.firebasedatabase.app");
    window.firebase = { db, ref, set, get, child };
  </script>

  <meta charset="UTF-8" />
  <title>JEU DE 24H</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 50vh;
      width: 100%;
    }
    iframe {
      width: 100%;
      height: 500px;
      border: none;
    }
    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-top: 20px;
    }
    .leaflet-popup-content {
      font-size: 25px;
      font-family: Arial, sans-serif;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <h1>Validez une nouvelle balise</h1>
  <iframe src="login.html" id="loginFrame"></iframe>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([50.364481451398525, 5.55291543783812], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const baliseLocations = {
      "92": [50.451417, 5.615889],
      "93": [50.416139, 5.597556],
      "94": [50.410806, 5.640083],
      "95": [50.447583, 5.526361],
      "96": [50.353056, 5.439889],
      "97": [50.320083, 5.552917],
      "98": [50.396694, 5.589361],
      "99": [50.417667, 5.503889],
      "100": [50.367722, 5.490444]
    };

    // Couleurs personnalisées pour chaque patrouille
    const patrouilleColors = {
      "Phénix": "#1E90FF",   // bleu dodger
      "Quokkas": "#32CD32",  // vert lime
      "Rats": "#8A2BE2",     // violet blue
      "Koalas": "#FFA500",   // orange
      "Vaches": "#FFFF00",   // jaune
      "Cougars": "#FF69B4",  // rose chaud
      "Poussins": "#00CED1", // turquoise
      "Chats": "#FF8C00"     // orange foncé
    };

    // Fonction pour créer une icône SVG Leaflet avec la couleur donnée
    function createColoredIcon(color) {
      return L.divIcon({
        className: "",
        html: `<svg xmlns="http://www.w3.org/2000/svg" width="25" height="41" viewBox="0 0 25 41" >
                 <path fill="${color}" stroke="black" stroke-width="1" d="M12.5 0C7 0 2.5 4.5 2.5 10c0 8.3 10 30 10 30s10-21.7 10-30c0-5.5-4.5-10-10-10z"/>
                 <circle cx="12.5" cy="10" r="5" fill="white"/>
               </svg>`,
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
    }

    const baliseMarkers = {};

    // Icone par défaut pour balises non validées (grise)
    const defaultIcon = createColoredIcon("#888888");

    L.marker(baliseLocations["CAMP"], { icon: redIcon }).bindPopup("CAMP").addTo(map);

    // Création des markers avec icône grise par défaut
    for (const [baliseId, coords] of Object.entries(baliseLocations)) {
      const marker = L.marker(coords, {
        title: `Balise ${baliseId}`,
        icon: defaultIcon
      }).addTo(map).bindPopup(`Balise ${baliseId}`);

      baliseMarkers[baliseId] = marker;
    }

    // Chargement des balises validées depuis Firebase au chargement
    window.addEventListener("DOMContentLoaded", async () => {
      const { db, ref, get } = window.firebase;

      try {
        const snapshot = await get(ref(db, 'balises_validées'));
        const pins = snapshot.val();

        if (pins) {
          for (const pinId in pins) {
            if (pins[pinId]) {
              turnPinColored(pinId, pins[pinId]);
            }
          }
        }
      } catch (error) {
        console.error("Error loading validated pins:", error);
      }
    });

    // Réception des messages validant les balises
    window.addEventListener("message", async (event) => {
      if (!event.data || !event.data.balise) return;

      const baliseId = event.data.balise;
      const patrouille = event.data.username;
      const marker = baliseMarkers[baliseId];
      if (!marker) return;

      const { db, ref, set, get } = window.firebase;

      const color = patrouilleColors[patrouille] || "#008000"; // vert par défaut
      const customIcon = createColoredIcon(color);

      marker.setIcon(customIcon);
      marker.bindPopup(`Balise ${baliseId} (validée par les ${patrouille})`).openPopup();

      await set(ref(db, 'balises_validées/' + baliseId), patrouille);
      await set(ref(db, 'infos_balises/' + Date.now()), {
        balise: baliseId,
        patrouille,
        heure: formatTimestamp(Date.now())
      });

      // Recharger toutes les balises validées pour garantir la synchro
      const snapshot = await get(ref(db, 'balises_validées'));
      const pins = snapshot.val();
      if (pins) {
        for (const pinId in pins) {
          if (pins[pinId]) {
            turnPinColored(pinId, pins[pinId]);
          }
        }
      }
    });

    // Change l'icône d'une balise validée avec la bonne couleur
    function turnPinColored(pinId, patrouille) {
      const marker = baliseMarkers[pinId];
      if (!marker) return;

      const color = patrouilleColors[patrouille] || "#008000"; // vert par défaut
      const customIcon = createColoredIcon(color);

      marker.setIcon(customIcon);
      marker.bindPopup(`Balise ${pinId} (validée par ${patrouille})`);
    }

    // Formatage d'heure lisible
    function formatTimestamp(ts) {
      const date = new Date(ts);
      return date.getFullYear() + '-' +
        String(date.getMonth() + 1).padStart(2, '0') + '-' +
        String(date.getDate()).padStart(2, '0') + ' ' +
        String(date.getHours()).padStart(2, '0') + ':' +
        String(date.getMinutes()).padStart(2, '0');
    }
  </script>
</body>
</html>
