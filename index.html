<!DOCTYPE html>
<html lang="en">
<head>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDD8u8CBRjWRI-khUfJxmyINSeTMeqaF24",
      authDomain: "jeu-des-24.firebaseapp.com",
      projectId: "jeu-des-24",
      storageBucket: "jeu-des-24.firebasestorage.app",
      messagingSenderId: "948758114165",
      appId: "1:948758114165:web:edcb63e71fb41eca6eed3c",
      measurementId: "G-RNL88LYHW5"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app, "https://jeu-des-24-default-rtdb.europe-west1.firebasedatabase.app");
    window.firebase = { db, ref, set, get, child };
  </script>

  <meta charset="UTF-8" />
  <title>JEU DE 24H</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 50vh;
      width: 100%;
    }
    iframe {
      width: 100%;
      height: 500px;
      border: none;
    }
    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-top: 20px;
    }
    .leaflet-popup-content {
      font-size: 25px; /* or whatever size you want */
      font-family: Arial, sans-serif;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <h1>Validez une nouvelle balise</h1>
  <iframe src="login.html" id="loginFrame"></iframe>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([48.86, 2.35], 13); // METTRE ICI COORDONNEES DU CAMP !!!!

    // Basemap layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Balise locations: these can be customized
    const baliseLocations = {
      "CAMP": [48.87, 2.340],
      "1": [48.860, 2.340],
      "2": [48.861, 2.341],
      "3": [48.862, 2.342],
      "4": [48.863, 2.343],
      "5": [48.864, 2.344],
      "6": [48.865, 2.345],
      "7": [48.866, 2.346],
      "8": [48.867, 2.347],
      "9": [48.868, 2.348],
      "10": [48.869, 2.349],
      "11": [48.870, 2.350],
      "12": [48.871, 2.351],
      "13": [48.872, 2.352],
      "14": [48.873, 2.353],
      "15": [48.874, 2.354],
      "16": [48.875, 2.355],
      "17": [48.876, 2.356],
      "18": [48.877, 2.357],
      "19": [48.878, 2.358],
      "20": [48.879, 2.359],
      "21": [48.880, 2.360],
      "22": [48.881, 2.361],
      "23": [48.882, 2.362],
      "24": [48.883, 2.363],
      "25": [48.884, 2.364],
      "26": [48.885, 2.365],
      "27": [48.886, 2.366],
      "28": [48.887, 2.367],
      "29": [48.888, 2.368],
      "30": [48.889, 2.369],
      "31": [48.890, 2.370],
      "32": [48.891, 2.371],
      "33": [48.892, 2.372],
      "34": [48.893, 2.373],
      "35": [48.894, 2.374],
      "36": [48.895, 2.375],
      "37": [48.896, 2.376],
      "38": [48.897, 2.377],
      "39": [48.898, 2.378],
      "40": [48.899, 2.379],
      "41": [48.900, 2.380],
      "42": [48.901, 2.381],
      "43": [48.902, 2.382],
      "44": [48.903, 2.383],
      "45": [48.904, 2.384],
      "46": [48.905, 2.385],
      "47": [48.906, 2.386],
      "48": [48.907, 2.387],
      "49": [48.908, 2.388],
      "50": [48.909, 2.389],
      "51": [48.910, 2.390],
      "52": [48.911, 2.391],
      "53": [48.912, 2.392],
      "54": [48.913, 2.393],
      "55": [48.914, 2.394],
      "56": [48.915, 2.395],
      "57": [48.916, 2.396],
      "58": [48.917, 2.397],
      "59": [48.918, 2.398],
      "60": [48.919, 2.399],
      "61": [48.920, 2.400],
      "62": [48.921, 2.401],
      "63": [48.922, 2.402],
      "64": [48.923, 2.403],
      "65": [48.924, 2.404],
      "66": [48.925, 2.405],
      "67": [48.926, 2.406],
      "68": [48.927, 2.407],
      "69": [48.928, 2.408],
      "70": [48.929, 2.409]
    };

    // Store markers to reference later
    const baliseMarkers = {};

    const redIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    const blackIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    // Initialize balise markers
    for (const [baliseId, coords] of Object.entries(baliseLocations)) {
      if (baliseId === "CAMP") continue;
      const marker = L.marker(coords, {
        title: `Balise ${baliseId}`,
        icon: blackIcon
      }).addTo(map).bindPopup(`Balise ${baliseId}`);

      baliseMarkers[baliseId] = marker;
    }

    L.marker(baliseLocations["CAMP"], { icon: redIcon }).bindPopup("CAMP").addTo(map);


    // Load and turn green all previously validated pins on page load
    window.addEventListener("DOMContentLoaded", async () => {
      const { db, ref, get } = window.firebase;

      try {
        const snapshot = await get(ref(db, 'validatedPins'));
        const pins = snapshot.val();

        if (pins) {
          for (const pinId in pins) {
            if (pins[pinId]) {
              turnPinGreen(pinId);
            }
          }
        }
      } catch (error) {
        console.error("Error loading validated pins:", error);
      }
    });

    // Listen for messages from login.html
    window.addEventListener("message", async (event) => {
      console.log("Received message from login.html:", event.data);
      if (!event.data || !event.data.balise) return;

      const baliseId = event.data.balise;

      const marker = baliseMarkers[baliseId];
      if (!marker) return;

      const { db, ref, set, get, child } = window.firebase;

      if (marker) {
        const greenIcon = new L.Icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
          shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });

        marker.setIcon(greenIcon);
        marker.bindPopup(`Balise ${baliseId} (validée)`).openPopup();
        await set(ref(db, 'validatedPins/' + baliseId), true);

        // Retrieve all validated pins
        const snapshot = await get(ref(db, 'validatedPins'));
        const pins = snapshot.val();
        if (pins) {
        for (const pinId in pins) {
            if (pins[pinId]) {
              turnPinGreen(pinId);
            }
          }
        }
      }
    });

    function turnPinGreen(pinId) {
      const marker = baliseMarkers[pinId];
      if (marker) {
        const greenIcon = new L.Icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
          shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });

        marker.setIcon(greenIcon);
        marker.bindPopup(`Balise ${pinId} (validée)`);
        }
      }
  </script>
</body>
</html>
