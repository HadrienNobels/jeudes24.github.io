<!DOCTYPE html>
<html lang="en">
<head>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDD8u8CBRjWRI-khUfJxmyINSeTMeqaF24",
      authDomain: "jeu-des-24.firebaseapp.com",
      projectId: "jeu-des-24",
      storageBucket: "jeu-des-24.firebasestorage.app",
      messagingSenderId: "948758114165",
      appId: "1:948758114165:web:edcb63e71fb41eca6eed3c",
      measurementId: "G-RNL88LYHW5"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app, "https://jeu-des-24-default-rtdb.europe-west1.firebasedatabase.app");
    window.firebase = { db, ref, set, get, child };
  </script>

  <meta charset="UTF-8" />
  <title>JEU DE 24H</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 50vh;
      width: 100%;
    }
    iframe {
      width: 100%;
      height: 500px;
      border: none;
    }
    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-top: 20px;
    }
    .leaflet-popup-content {
      font-size: 25px;
      font-family: Arial, sans-serif;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <h1>Validez une nouvelle balise</h1>
  <iframe src="login.html" id="loginFrame"></iframe>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([50.364481451398525, 5.55291543783812], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const storedUsers = {
            "1": "83427691",
            "2": "10928473",
            "3": "56782934",
            "4": "23489017",
            "5": "78120345",
            "6": "45213890",
            "7": "98347126",
            "8": "12439875",
            "9": "76420398",
            "10": "39487510",
            "11": "80213476",
            "12": "62398745",
            "13": "13984276",
            "14": "87439201",
            "15": "23019847",
            "16": "95830217",
            "17": "74819283",
            "18": "39028476",
            "19": "56123098",
            "20": "81923764",
            "21": "70238491",
            "22": "18402937",
            "23": "67382910",
            "24": "29487120",
            "25": "43890214",
            "26": "15832097",
            "27": "61028473",
            "28": "89234710",
            "29": "94382714",
            "30": "78120493",
            "31": "29384750",
            "32": "12039485",
            "33": "76543928",
            "34": "84730192",
            "35": "30847219",
            "36": "54932018",
            "37": "67239481",
            "38": "31829745",
            "39": "90384720",
            "40": "68124903",
            "41": "29478310",
            "42": "71823490",
            "43": "82309472",
            "44": "10394827",
            "45": "29483715",
            "46": "87239401",
            "47": "43678291",
            "48": "50918234",
            "49": "91827364",
            "50": "87420398",
            "51": "28374629",
            "52": "76128394",
            "53": "39481203",
            "54": "12938476",
            "55": "89017234",
            "56": "62394810",
            "57": "73284901",
            "58": "48102937",
            "59": "19384720",
            "60": "58029347",
            "61": "10293847",
            "62": "32018473",
            "63": "47382910",
            "64": "29817364",
            "65": "73120984",
            "66": "59482017",
            "67": "78239481",
            "68": "18237490",
            "69": "94738201",
            "70": "36481920",
          "71": "19382047",
"72": "84930217",
"73": "23984710",
"74": "98412039",
"75": "38192048",
"76": "56473829",
"77": "72038491",
"78": "19837465",
"79": "84719203",
"80": "50938476",
"81": "72198304",
"82": "39847210",
"83": "13298476",
"84": "84730219",
"85": "62198473",
"86": "98347210",
"87": "34219847",
"88": "58012938",
"89": "76482901",
"90": "21837465",
"91": "49572038",
"92": "68372940",
"93": "32098471",
"94": "10928374",
"95": "78230419",
"96": "69384720",
"97": "81209384",
"98": "57283910",
"99": "93740281",
"100": "28473109"

            };


    const patrouilleIcons = {
      "Phénix": "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png",
      "Quokkas": "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png",
      "Rats": "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png",
      "Koalas": "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png",
      "Vaches": "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
      "Cougars": "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-pink.png",
      "Poussins": "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
      "Chats": "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png"
    };

    const baliseMarkers = {};

    const blackIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    const redIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    for (const [baliseId, coords] of Object.entries(baliseLocations)) {
      if (baliseId === "CAMP") continue;

      const marker = L.marker(coords, {
        title: `Balise ${baliseId}`,
        icon: blackIcon
      }).addTo(map).bindPopup(`Balise ${baliseId}`);

      baliseMarkers[baliseId] = marker;
    }

    L.marker(baliseLocations["CAMP"], { icon: redIcon }).bindPopup("CAMP").addTo(map);

    window.addEventListener("DOMContentLoaded", async () => {
      const { db, ref, get } = window.firebase;

      try {
        const snapshot = await get(ref(db, 'balises_validées'));
        const pins = snapshot.val();

        if (pins) {
          for (const pinId in pins) {
            if (pins[pinId]) {
              turnPinGreen(pinId, pins[pinId]);
            }
          }
        }
      } catch (error) {
        console.error("Error loading validated pins:", error);
      }
    });

    window.addEventListener("message", async (event) => {
      if (!event.data || !event.data.balise) return;

      const baliseId = event.data.balise;
      const patrouille = event.data.username;
      const marker = baliseMarkers[baliseId];
      if (!marker) return;

      const { db, ref, set, get } = window.firebase;

      const iconUrl = patrouilleIcons[patrouille] ||
        "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png";

      const customIcon = new L.Icon({
        iconUrl,
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      marker.setIcon(customIcon);
      marker.bindPopup(`Balise ${baliseId} (validée par ${patrouille})`).openPopup();

      await set(ref(db, 'balises_validées/' + baliseId), patrouille);
      await set(ref(db, 'infos_balises/' + Date.now()), {
        balise: baliseId,
        patrouille,
        heure: formatTimestamp(Date.now())
      });

      const snapshot = await get(ref(db, 'balises_validées'));
      const pins = snapshot.val();
      if (pins) {
        for (const pinId in pins) {
          if (pins[pinId]) {
            turnPinGreen(pinId, pins[pinId]);
          }
        }
      }
    });

    function turnPinGreen(pinId, patrouille) {
      const marker = baliseMarkers[pinId];
      if (!marker) return;

      const iconUrl = patrouilleIcons[patrouille] ||
        "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png";

      const customIcon = new L.Icon({
        iconUrl,
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      marker.setIcon(customIcon);
      marker.bindPopup(`Balise ${pinId} (validée par ${patrouille})`);
    }

    function formatTimestamp(ts) {
      const date = new Date(ts);
      return date.getFullYear() + '-' +
        String(date.getMonth() + 1).padStart(2, '0') + '-' +
        String(date.getDate()).padStart(2, '0') + ' ' +
        String(date.getHours()).padStart(2, '0') + ':' +
        String(date.getMinutes()).padStart(2, '0');
    }
  </script>
</body>
</html>
