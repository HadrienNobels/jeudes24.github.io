
<!-- A FAIRE
Changer noms des patrouilles
Ajouter coordonnées des balises et du camp
Vérifier zoom de la map de base; faut que toutes les balises soient visibles sur la carte de base sur tel !
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDD8u8CBRjWRI-khUfJxmyINSeTMeqaF24",
      authDomain: "jeu-des-24.firebaseapp.com",
      projectId: "jeu-des-24",
      storageBucket: "jeu-des-24.firebasestorage.app",
      messagingSenderId: "948758114165",
      appId: "1:948758114165:web:edcb63e71fb41eca6eed3c",
      measurementId: "G-RNL88LYHW5"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app, "https://jeu-des-24-default-rtdb.europe-west1.firebasedatabase.app");
    window.firebase = { db, ref, set, get, child };

  </script>

  <meta charset="UTF-8" />
  <title>JEU DE 24H</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 50vh;
      width: 100%;
    }
    iframe {
      width: 100%;
      height: 500px;
      border: none;
    }
    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-top: 20px;
    }
    .leaflet-popup-content {
      font-size: 25px; /* or whatever size you want */
      font-family: Arial, sans-serif;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <h1>Validez une nouvelle balise</h1>
  <iframe src="login.html" id="loginFrame"></iframe>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([50.364481451398525, 5.55291543783812], 15);
    // Basemap layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Balise locations: these can be customized
    const baliseLocations = {
      "CAMP": [50.364481451398525, 5.55291543783812],
  "1": [50.367917, 5.518556],
  "2": [50.3765, 5.520944],
  "3": [50.371056, 5.537417],
  "4": [50.363972, 5.531333],
  "5": [50.353333, 5.53575],
  "6": [50.352333, 5.507528],
  "7": [50.348611, 5.552472],
  "8": [50.346583, 5.56775],
  "9": [50.3345, 5.523333],
  "10": [50.341306, 5.505111],
  "11": [50.3345, 5.45],
  "12": [50.367, 5.438528],
  "13": [50.388667, 5.47825],
  "14": [50.360444, 5.474833],
  "15": [50.381083, 5.587444],
  "16": [50.398028, 5.608528],
  "17": [50.395, 5.556139],
  "18": [50.402694, 5.525111],
  "19": [50.321, 5.575556],
  "20": [50.300472, 5.510722],
  "21": [50.324889, 5.490028],
  "22": [50.285917, 5.442806],
  "23": [50.36175, 5.6215],
  "24": [50.384417, 5.641667],
  "25": [50.393111, 5.619167],
  "26": [50.327167, 5.628417],
  "27": [50.298778, 5.600861],
  "28": [50.306194, 5.554861],
  "29": [50.310694, 5.480472],
  "30": [50.285917, 5.473556],
  "31": [50.302639, 5.494944],
  "32": [50.319694, 5.449111],
  "33": [50.330028, 5.545972],
  "34": [50.407944, 5.488056],
  "35": [50.411694, 5.442556],
  "36": [50.434306, 5.437444],
  "37": [50.43475, 5.457306],
  "38": [50.441167, 5.468972],
  "39": [50.456444, 5.512111],
  "40": [50.429611, 5.634611],
  "41": [50.428722, 5.541306],
  "42": [50.445611, 5.600139],
  "43": [50.455989, 5.550417],
  "44": [50.454278, 5.571833],
  "45": [50.451778, 5.592083],
  "46": [50.430722, 5.586139],
  "47": [50.406694, 5.573333],
  "48": [50.388417, 5.5565],
  "49": [50.279639, 5.546472],
  "50": [50.2945, 5.573167],
  "51": [50.357639, 5.580528],
  "52": [50.281472, 5.635972],
  "53": [50.280278, 5.616361],
  "54": [50.279, 5.573778],
  "55": [50.280583, 5.518944],
  "56": [50.312528, 5.611278],
  "57": [50.302861, 5.618417],
  "58": [50.326028, 5.639667],
  "59": [50.332, 5.632694],
  "60": [50.342028, 5.600417],
  "61": [50.355611, 5.603556],
  "62": [50.381222, 5.618972],
  "63": [50.374389, 5.641194],
  "64": [50.412889, 5.560389],
  "65": [50.436833, 5.565556],
  "66": [50.440278, 5.499028],
  "67": [50.434583, 5.618556],
  "68": [50.418083, 5.627639],
  "69": [50.425028, 5.611861],
  "70": [50.445, 5.628333],
  "71": [50.419722, 5.468222],
  "72": [50.425028, 5.481611],
  "73": [50.377444, 5.570583],
  "74": [50.35125, 5.632944],
  "75": [50.319222, 5.629917],
  "76": [50.294389, 5.639861],
  "77": [50.318472, 5.512944],
  "78": [50.318778, 5.489222],
  "79": [50.383306, 5.442444],
  "80": [50.396389, 5.459361],
  "81": [50.396806, 5.504028],
  "82": [50.418833, 5.527944],
  "83": [50.37575, 5.599028],
  "84": [50.326306, 5.596417],
  "85": [50.336806, 5.471667],
  "86": [50.302944, 5.532139],
  "87": [50.383611, 5.497028],
  "88": [50.308389, 5.585333],
  "89": [50.307472, 5.448028],
  "90": [50.300667, 5.473389],
  "91": [50.293306, 5.498222],
  "92": [50.452889, 5.617417],
  "93": [50.416139, 5.597556],
  "94": [50.410806, 5.640083],
  "95": [50.447583, 5.526361],
  "96": [50.353056, 5.439889],
  "97": [50.320083, 5.552917],
  "98": [50.396694, 5.589361],
  "99": [50.417667, 5.503889],
  "100": [50.367722, 5.490444]
    };

    // Store markers to reference later
    const baliseMarkers = {};

    const redIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    const blackIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    // Initialize balise markers
    for (const [baliseId, coords] of Object.entries(baliseLocations)) {
      if (baliseId === "CAMP") continue;
      const marker = L.marker(coords, {
        title: `Balise ${baliseId}`,
        icon: blackIcon
      }).addTo(map).bindPopup(`Balise ${baliseId}`);

      baliseMarkers[baliseId] = marker;
    }

    L.marker(baliseLocations["CAMP"], { icon: redIcon }).bindPopup("CAMP").addTo(map);


    // Load and turn green all previously validated pins on page load
    window.addEventListener("DOMContentLoaded", async () => {
      const { db, ref, get } = window.firebase;

      try {
        const snapshot = await get(ref(db, 'balises_validées'));
        const pins = snapshot.val();

        if (pins) {
          for (const pinId in pins) {
            if (pins[pinId]) {
              turnPinGreen(pinId);
            }
          }
        }
      } catch (error) {
        console.error("Error loading validated pins:", error);
      }
    });

    // Listen for messages from login.html
    window.addEventListener("message", async (event) => {
      console.log("Received message from login.html:", event.data);
      if (!event.data || !event.data.balise) return;

      const baliseId = event.data.balise;

      const marker = baliseMarkers[baliseId];
      if (!marker) return;

      const { db, ref, set, get, child } = window.firebase;

      if (marker) {
        const greenIcon = new L.Icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
          shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });

        marker.setIcon(greenIcon);
        marker.bindPopup(`Balise ${baliseId} (validée)`).openPopup();
        await set(ref(db, 'balises_validées/' + baliseId), true);
        await set(ref(db, 'infos_balises/' + Date.now()), {balise: baliseId, patrouille:event.data.username, heure:formatTimestamp(Date.now())});

        // Retrieve all validated pins
        const snapshot = await get(ref(db, 'balises_validées'));
        const pins = snapshot.val();
        if (pins) {
        for (const pinId in pins) {
            if (pins[pinId]) {
              turnPinGreen(pinId);
            }
          }
        }
      }
    });

    function turnPinGreen(pinId) {
      const marker = baliseMarkers[pinId];
      if (marker) {
        const greenIcon = new L.Icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
          shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });

        marker.setIcon(greenIcon);
        marker.bindPopup(`Balise ${pinId} (validée)`);
        }
      }

      function formatTimestamp(ts) {
        const date = new Date(ts);
        return date.getFullYear() + '-' +
          String(date.getMonth() + 1).padStart(2, '0') + '-' +
          String(date.getDate()).padStart(2, '0') + ' ' +
          String(date.getHours()).padStart(2, '0') + ':' +
          String(date.getMinutes()).padStart(2, '0');
      }
  </script>
</body>
</html>
